name: ðŸ”’ Security & Functionality Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  security-tests:
    name: ðŸ›¡ï¸ Security Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Setup Nim
      run: |
        curl https://nim-lang.org/choosenim/init.sh -sSf | sh -s -- -y
        echo "/home/runner/.nimble/bin" >> $GITHUB_PATH

    - name: ðŸ“¦ Install Dependencies
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        nimble refresh -y
        nimble install -y --depsOnly

    - name: ðŸ—ï¸ Build Library
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        nim c --verbosity:0 src/nim_chacha20_poly1305.nim

    - name: ðŸ”’ Security Tests
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        nim c -r tests/test_security_hardened.nim

    - name: ðŸ§ª Core Tests
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        nim c -r tests/test_poly1305.nim
        nim c -r tests/test_chacha20.nim

    - name: ðŸŒŠ Streaming Tests
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        nim c -r tests/test_streaming_basic.nim

    - name: ðŸ›¡ï¸ Integration Tests
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        echo "ðŸ§ª Testing ChaCha20-Poly1305 AEAD integration..."
        nim c -r tests/test_chacha20_poly1305.nim

    - name: ðŸ” XChaCha20 Tests
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        nim c -r tests/test_xchacha20_poly1305.nim

    - name: ðŸ“Š Release Build
      run: |
        export PATH="/home/runner/.nimble/bin:$PATH"
        nim c -d:release --opt:speed src/nim_chacha20_poly1305.nim

    - name: ðŸ“ Test Summary
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Build: Complete" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: Executed" >> $GITHUB_STEP_SUMMARY
